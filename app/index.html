<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Anxious Monkey — Lite v0.3</title>
  <style>
    :root{
      --bg:#0c0f13;
      --panel:#141922;
      --muted:#8b93a1;
      --text:#e7eef7;
      --accent:#00d1b2; /* TEAL to prove version change */
      --accent-weak:#00d1b21a;
      --ok:#24d17e;
      --warn:#ffd166;
      --err:#ff5c5c;
      --chip:#1d2330;
      --chip-border:#2b3342;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 800px at 120% -20%, #0d141c 20%, transparent 60%) no-repeat, var(--bg);
      color:var(--text);
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 18px;border-bottom:1px solid #1d2330;background:linear-gradient(180deg,#0f131a, #0b0e13);
      position:sticky;top:0;z-index:5;
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--ok);box-shadow:0 0 8px var(--ok)}
    .brand small{font-weight:600;color:var(--muted);margin-left:6px}
    button.refresh{
      background:var(--accent);color:#001411;border:none;border-radius:10px;
      padding:8px 14px;font-weight:700;cursor:pointer;box-shadow:0 8px 16px var(--accent-weak);
    }
    main{padding:18px;display:grid;gap:14px;grid-template-columns: repeat(12, 1fr);}
    .card{
      background:var(--panel);border:1px solid #1b2230;border-radius:14px;
      padding:14px 16px;min-height:84px;
      box-shadow:0 10px 28px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.02);
    }
    .kpi{display:flex;flex-direction:column;gap:8px}
    .kpi h4{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:600}
    .kpi .value{font-size:22px;font-weight:800;letter-spacing:.2px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      background:var(--chip);border:1px solid var(--chip-border);color:var(--text);font-weight:600;font-size:13px;
    }
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid #2b3342;background:#121824;color:var(--muted);font-size:12px}
    .pill.ok{color:#aefbd0;border-color:#153022;background:#0b1d15}
    .pill.warn{color:#ffe6a6;border-color:#3a2f09;background:#1b1505}
    .pill.err{color:#ffb0b0;border-color:#3c0d0d;background:#1b0b0b}
    .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .title h3{margin:0;font-size:14px;color:var(--muted);font-weight:700;letter-spacing:.3px;text-transform:uppercase}
    .weights{display:grid;gap:10px}
    .bar{height:8px;background:#0f1420;border-radius:6px;overflow:hidden;border:1px solid #1d2432}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#8af3e4)}
    .row-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    /* layout */
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}
    @media (max-width: 960px){
      .col-6,.col-8{grid-column:span 12}
      .row-grid{grid-template-columns:1fr}
    }
    footer{padding:10px 16px;color:var(--muted);font-size:12px}
    code.url{color:#9bdcff;background:#08131a;border:1px solid #143243;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span> Anxious Monkey — <span style="color:var(--accent);font-weight:800">Lite v0.3</span><small id="ts"></small></div>
    <div class="row">
      <span id="health" class="pill">loading…</span>
      <button class="refresh" id="btnRefresh">Refresh</button>
    </div>
  </header>

  <main>
    <!-- KPIs -->
    <section class="card kpi col-3"><h4>NAAIM</h4><div class="value" id="k_naaim">—</div></section>
    <section class="card kpi col-3"><h4>&gt;50DMA (NDX)</h4><div class="value" id="k_ndx">—</div></section>
    <section class="card kpi col-3"><h4>China (FXI)</h4><div class="value" id="k_china">—</div></section>
    <section class="card kpi col-3"><h4>FRED Macro</h4><div class="value" id="k_fred">—</div></section>

    <!-- Weights -->
    <section class="card col-6">
      <div class="title"><h3>Factor Weights</h3><div class="legend" id="w_legend"></div></div>
      <div class="weights" id="weights"></div>
    </section>

    <!-- Playbook -->
    <section class="card col-6">
      <div class="title"><h3>Playbook</h3><span id="play_src" class="pill">—</span></div>
      <div id="play" style="white-space:pre-wrap;line-height:1.6"></div>
    </section>

    <!-- Factors Panels -->
    <section class="card col-4">
      <div class="title"><h3>NAAIM Exposure</h3><span id="src_naaim" class="pill">—</span></div>
      <div id="p_naaim" class="row"></div>
    </section>
    <section class="card col-4">
      <div class="title"><h3>&gt;50DMA Breadth (NDX)</h3><span id="src_ndx" class="pill">—</span></div>
      <div id="p_ndx" class="row"></div>
    </section>
    <section class="card col-4">
      <div class="title"><h3>FRED Macro (DGS10, DFF)</h3><span id="src_fred" class="pill">—</span></div>
      <div id="p_fred" class="row"></div>
    </section>

    <!-- Spot -->
    <section class="card col-12">
      <div class="title"><h3>Spot</h3><span id="src_prices" class="pill">—</span></div>
      <div id="spot" class="row"></div>
    </section>
  </main>

  <footer>
    Data URLs — factors: <code class="url" id="u_factors">n/a</code> · model: <code class="url" id="u_model">n/a</code> · prices: <code class="url" id="u_prices">n/a</code>
  </footer>

<script>
const VER = "v0.3";
document.getElementById("ts").textContent = new Date().toLocaleString();

const NEED = {
  factors: "factors_namm50.json",
  model:   "models/namm50.json",
  prices:  "prices.json",
};

// Build candidate paths for a file under GitHub Pages
function candidateURLs(file){
  const origin = window.location.origin;
  const path = window.location.pathname;
  // repo root guess (common on GitHub Pages)
  const repo = (path.includes("/anxiousmonkey-backtests/"))
    ? "/anxiousmonkey-backtests/"
    : path.split("/").slice(0,2).join("/") + "/"; // fallback "/<repo>/" or "/"

  const baseDir = path.endsWith("/") ? path : path.replace(/\/[^\/]*$/, "/");
  const appDir = baseDir; // where index.html lives

  const uniq = "t="+Date.now();
  const list = [
    origin + appDir + file,                      // ./file (same dir)
    origin + repo + file,                        // /repo/file (GH Pages)
    origin + "/" + file,                         // /file (site root)
    file                                         // relative
  ];
  // add with cache buster
  return [...new Set(list)].map(u => u + (u.includes("?") ? "&" : "?") + uniq);
}

async function fetchFirstJSON(file){
  const urls = candidateURLs(file);
  let lastErr = null;
  for (const url of urls){
    try{
      const r = await fetch(url, {cache:"no-store"});
      if (!r.ok) throw new Error("HTTP "+r.status);
      const j = await r.json();
      return {data:j, url};
    }catch(e){ lastErr = e; }
  }
  throw new Error("All candidates failed for "+file+" ("+lastErr+")");
}

// helpers
const el = sel => document.querySelector(sel);
const fmt = (x, d=2) => (typeof x==="number" && isFinite(x)) ? x.toFixed(d) : "—";
const pct = x => (typeof x==="number" && isFinite(x)) ? (x*100).toFixed(1)+"%" : "—";

function lastNumber(series){
  if (!series) return null;
  if (Array.isArray(series)){
    for (let i=series.length-1;i>=0;i--){
      const row = series[i];
      // handle [idx, ts?, val] or {value:}
      if (Array.isArray(row)){
        const v = row[row.length-1];
        if (typeof v === "number" && isFinite(v)) return v;
      }else if (row && typeof row==="object" && typeof row.value==="number"){
        return row.value;
      }
    }
  }
  return null;
}

function setPill(id, state, txt){
  const p = el(id); if (!p) return;
  p.classList.remove("ok","warn","err");
  if (state) p.classList.add(state);
  p.textContent = txt || state || "—";
}

(async function init(){
  // health thaw
  setPill("#health","warn","loading…");
  const results = { factors:null, model:null, prices:null };
  try{
    results.factors = await fetchFirstJSON(NEED.factors);
    el("#u_factors").textContent = results.factors.url;
    setPill("#src_naaim","ok","factors");
    setPill("#src_ndx","ok","factors");
    setPill("#src_fred","ok","factors");
  }catch(e){
    alert("加载失败: factors ["+e.message+"]");
    setPill("#src_naaim","err","404");
    setPill("#src_ndx","err","404");
    setPill("#src_fred","err","404");
  }

  try{
    results.model = await fetchFirstJSON(NEED.model);
    el("#u_model").textContent = results.model.url;
    setPill("#play_src","ok","model");
  }catch(e){
    setPill("#play_src","err","404");
  }

  try{
    results.prices = await fetchFirstJSON(NEED.prices);
    el("#u_prices").textContent = results.prices.url;
    setPill("#src_prices","ok","prices");
  }catch(e){
    setPill("#src_prices","warn","missing");
  }

  // KPIs from factors if available
  const f = results.factors?.data || {};
  const fx = f.factors || {};
  const naaim = lastNumber(fx.naaim_exposure?.series);
  const ndx   = lastNumber(fx.ndx_breadth?.series);
  const china = lastNumber(fx.china_proxy?.series);
  const fred  = lastNumber(fx.fred_macro?.series);
  el("#k_naaim").textContent = (naaim!=null ? fmt(naaim,2) : "—");
  el("#k_ndx").textContent   = (ndx!=null ? pct(ndx) : "—");
  el("#k_china").textContent = (china!=null ? fmt(china,2) : "—");
  el("#k_fred").textContent  = (fred!=null ? fmt(fred,2) : "—");

  // factor panels show small chips with latest
  if (naaim!=null) el("#p_naaim").innerHTML = `<span class="chip">latest: ${fmt(naaim,2)}</span>`;
  if (ndx!=null)   el("#p_ndx").innerHTML   = `<span class="chip">above 50dma: ${pct(ndx)}</span>`;
  if (fred!=null)  el("#p_fred").innerHTML  = `<span class="chip">score: ${fmt(fred,2)}</span>`;

  // Weights
  const m = results.model?.data || {};
  const weights = m.weights || {};
  const wContainer = el("#weights");
  const legend = el("#w_legend");
  wContainer.innerHTML = "";
  legend.innerHTML = "";
  let sum=0; Object.values(weights).forEach(v=>{ if(typeof v==="number") sum+=v; });
  for (const [k,v] of Object.entries(weights)){
     if (typeof v!=="number") continue;
     const pctw = sum>0 ? (v/sum*100) : 0;
     const row = document.createElement("div");
     row.innerHTML = `<div class="row" style="justify-content:space-between;">
         <div class="chip" style="padding:4px 8px">${k}</div>
         <div style="color:var(--muted);font-size:12px">${pctw.toFixed(1)}%</div>
       </div>
       <div class="bar"><i style="width:${pctw.toFixed(1)}%"></i></div>`;
     wContainer.appendChild(row);
     const lg = document.createElement("span");
     lg.className="pill";
     lg.textContent=`${k}: ${pctw.toFixed(1)}%`;
     legend.appendChild(lg);
  }

  // Spot tickers
  const want = ["SPY","QQQ","TQQQ","SOXL","FEZ","CURE"];
  const px = results.prices?.data || {};
  const spot = el("#spot");
  if (px && typeof px==="object"){
    for (const s of want){
      const v = px[s];
      if (v==null) continue;
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.innerHTML = `<strong>${s}</strong> ${fmt(v,2)}`;
      spot.appendChild(chip);
    }
  }
  if (!spot.children.length) spot.textContent = "No prices yet.";

  // Playbook (simplified, data-aware)
  let pb = "";
  const hasModel = !!results.model;
  const hasFactors = !!results.factors;
  if (hasModel && hasFactors){
     pb = "Neutral · 观察为主；仅在强信号共振时加减仓，保持中性敞口。";
  }else if (hasModel){
     pb = "Model ready but factors missing · 仅根据模型低频信号做轻仓位调整。";
  }else if (hasFactors){
     pb = "Factors ready but model missing · 使用原始因子阈值进行保守判断。";
  }else{
     pb = "数据未就绪 · 暂不操作。";
  }
  el("#play").textContent = "Playbook: "+pb;

  // Health
  const ok = (results.factors && results.model);
  setPill("#health", ok? "ok": "warn", ok? "live" : "degraded");

  // refresh
  document.getElementById("btnRefresh").onclick = ()=> location.reload();
})().catch(err=>{
  alert("致命错误: "+err.message);
});
</script>
</body>
</html>
